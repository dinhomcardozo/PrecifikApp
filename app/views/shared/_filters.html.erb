<%= form_with url: request.path, method: :get, local: true, class: "filters-form" do |f| %>
  <div class="filters-grid">

    <!-- Subprodutos -->
    <div class="filters-col">
      <%= f.label :subproduct_ids, "Subprodutos" %>
      <% selected = Array.wrap(params[:subproduct_ids]).reject(&:blank?) %>
      <% preloaded = Subproduct.where(id: selected).pluck(:id, :name) %>
      <%= f.select :subproduct_ids,
            options_for_select(preloaded, selected),
            {},
            multiple: true,
            data: {
              controller: "select2",
              select2UrlValue: search_subproducts_path,
              select2PlaceholderValue: "Buscar por SUBPRODUTO…",
              select2MinimumInputLengthValue: 2
            } %>
    </div>

    <!-- Insumos -->
    <div class="filters-col">
      <%= f.label :input_ids, "Insumos" %>
      <% selected_ins = Array.wrap(params[:input_ids]).reject(&:blank?) %>
      <% pre_ins    = Input.where(id: selected_ins).pluck(:id, :name) %>
      <%= f.select :input_ids,
            options_for_select(pre_ins, selected_ins),
            {},
            multiple: true,
            data: {
              controller: "select2",
              select2UrlValue: search_inputs_path,
              select2PlaceholderValue: "Buscar por INSUMO…",
              select2MinimumInputLengthValue: 2
            } %>
    </div>

    <!-- Marca -->
    <div class="filters-col">
      <%= f.label :brand_id, "Marca" %>
      <% sel_brand = Array.wrap(params[:brand_id]).reject(&:blank?) %>
      <% pre_brand = Brand.where(id: sel_brand).pluck(:id, :name) %>
      <%= f.select :brand_id,
            options_for_select(pre_brand, sel_brand),
            {},
            data: {
              controller: "select2",
              select2UrlValue: search_brands_path,
              select2PlaceholderValue: "Buscar por MARCA…",
              select2MinimumInputLengthValue: 2
            } %>
    </div>

    <!-- Busca geral (nome/descrição) -->
    <div class="filters-col">
      <%= f.label :q, "Geral (nome/descrição)" %>
      <% pre_q = params[:q].present? ? [[params[:q], params[:q]]] : [] %>
      <%= f.select :q,
            options_for_select(pre_q),
            {},
            data: {
              controller: "select2",
              select2UrlValue: search_products_path,
              select2PlaceholderValue: "Buscar em NOME/DESCRIÇÃO…",
              select2MinimumInputLengthValue: 2
            } %>
    </div>

    <div class="filters-actions">
      <%= link_to "LIMPAR FILTROS",
            url_for(request.query_parameters.except("subproduct_ids", "input_ids", "brand_id", "q")),
            class: "mini-button" %>
      <%= f.submit "APLICAR FILTROS", class: "mini-button" %>
    </div>
  </div>
<% end %>