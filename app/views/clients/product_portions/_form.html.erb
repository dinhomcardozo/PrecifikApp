<%= form_with(model: product_portion) do |form| %>

  <!-- Produto -->
  <div>
    <%= form.label :product_id, "Produto" %>
    <%= form.collection_select :product_id,
          Product.all.order(:description),
          :id, :description,
          { prompt: "Selecione um produto" },
          class: "form-select" %>
  </div>

  <!-- Quantidade porcionada -->
  <div>
    <%= form.label :portioned_quantity, "Quantidade porcionada (g)" %>
    <%= form.number_field :portioned_quantity, step: 0.01 %>
  </div>

  <!-- Preço final das embalagens -->
  <div>
    <%= form.label :final_package_price, "Preço Final das Embalagens" %>
    <%= form.text_field :final_package_price,
          readonly: true,
          data: { product_portion_pricing_target: "finalPackagePrice" } %>
  </div>

  <hr>

  <!-- Controller de precificação -->
  <section
    data-controller="product-portion-pricing"
    data-product-portion-pricing-base-cost-value="<%= product_portion.product.present? ? product_portion.product.total_cost.to_f : 0 %>"
    data-product-portion-pricing-fixed-cost-value="<%= SalesTarget.global_distributed_fixed_cost_live.to_f %>">

    <!-- Select de imposto -->
    <div class="field-inline">
      <%= form.label :tax_id, "Imposto" %>
      <%= form.select :tax_id,
            options_for_select(
              Tax.all.map { |t| [t.description, t.id, { "data-json": t.to_json }] },
              product_portion.tax_id
            ),
            { prompt: "– escolha um imposto –" },
            class: "form-select",
            data: { product_portion_pricing_target: "taxSelect",
                    action: "change->product-portion-pricing#fillTaxFields change->product-portion-pricing#recalculate" } %>
    </div>

    <!-- Alíquotas -->
    <% [:icms, :ipi, :pis_cofins, :difal, :iss, :cbs, :ibs].each do |attr| %>
      <div class="form-row-inline">
        <%= label_tag attr, attr.to_s.upcase %>
        <%= number_field_tag nil,
              product_portion.tax&.public_send(attr).to_f.round(2),
              readonly: true,
              step: 0.01,
              data: { product_portion_pricing_target: attr.to_s } %>
      </div>
    <% end %>

    <!-- Custo fixo distribuído -->
    <div class="form-row-inline">
      <%= label_tag :distributed_fixed_cost, "Custo Fixo Distribuído (R$)" %>
      <%= number_field_tag nil,
            SalesTarget.global_distributed_fixed_cost_live.to_f,
            readonly: true,
            step: 0.01,
            data: { product_portion_pricing_target: "distributedFixedCost" } %>
    </div>

    <!-- Custo final calculado -->
    <div class="form-row-inline">
      <%= form.label :final_cost, "Custo Final (R$)" %>
      <%= form.text_field :final_cost,
            readonly: true,
            step: 0.01,
            data: { product_portion_pricing_target: "finalCost" } %>
    </div>

    <!-- Preço final calculado -->
    <div class="form-row-inline">
      <%= form.label :final_price, "Preço Final (R$)" %>
      <%= form.text_field :final_price,
            readonly: true,
            step: 0.01 %>
    </div>
  </section>

  <hr>

  <!-- Portion Packages (nested) -->
  <h3>Embalagens</h3>
    <div data-controller="portion-packages">
      <div data-portion-packages-target="container">
        <%= form.fields_for :portion_packages do |pp_form| %>
          <%= render "portion_package_fields", f: pp_form %>
        <% end %>
      </div>

      <template data-portion-packages-target="template">
        <%= form.fields_for :portion_packages, PortionPackage.new, child_index: "NEW_RECORD" do |pp_form| %>
          <%= render "portion_package_fields", f: pp_form %>
        <% end %>
      </template>

      <%= button_tag "Adicionar Embalagem",
                    type: "button",
                    data: { action: "portion-packages#add" },
                    class: "action-button" %>
    </div>

  <div>
    <%= form.submit "Salvar", class: "action-button" %>
  </div>
<% end %>