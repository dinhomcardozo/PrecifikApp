<main class="index-container">
  <%= form_with model: @service,
                url: @service.new_record? ? clients_services_services_path : clients_services_service_path(@service),
                method: @service.new_record? ? :post : :patch,
                local: true do |f| %>

        <div data-controller="service-form">
      <% if @service.errors.any? %>
        <div class="error_explanation">
          <h2><%= pluralize(@service.errors.count, "erro") %> proibiu este serviço de ser salvo:</h2>
          <ul>
            <% @service.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="form-inputs">

        <!-- Linha 1: Descrição + Profissional -->
        <div class="form-row">
          <div class="field">
            <%= f.label :description, "Descrição" %>
            <%= f.text_field :description, class: "form-control" %>
          </div>

          <div class="field">
            <%= f.label :professional_id, "Profissional" %>
            <%= f.select :professional_id,
                        @professionals.map { |p| [p.full_name, p.id] },
                        { prompt: "Selecione Profissional" },
                        class: "form-control",
                        data: {
                          action: "change->service-form#loadHourlyRate",
                          "service-form-target": "professionalSelect"
                        } %>
          </div>
        </div>

        <!-- Linha 2: Hora técnica + Horas totais (raw) + Horas totais (hidden) -->
        <div class="form-row">
          <div class="field">
            <%= f.label :hourly_rate, "Hora Técnica (R$)" %>
            <%= f.number_field :hourly_rate,
                              readonly: true,
                              class: "form-control",
                              data: { "service-form-target": "hourlyRate" } %>
          </div>

          <div class="field">
            <%= f.label :total_hours_raw, "Horas totais (DD:HH:MM:SS)" %>
            <%= f.text_field :total_hours_raw,
                            value: @service.total_hours_raw,
                            placeholder: "00:00:00:00",
                            class: "form-control",
                            data: {
                              "service-form-target": "totalRaw",
                              action: "input->service-form#maskTotalHours blur->service-form#parseTotalHours"
                            } %>
          </div>

          <%= f.hidden_field :total_hours,
                            data: { "service-form-target": "totalDecimal" } %>
        </div>

        <!-- Linha 3: Tributos + Markup + Preço total -->
        <div class="form-row">
          <div class="field">
            <%= f.label :tax, "Tributos (%)" %>
            <%= f.number_field :tax,
                              step: 0.01,
                              class: "form-control",
                              data: {
                                "service-form-target": "tax",
                                action: "input->service-form#computeBasePrice"
                              } %>
          </div>

          <div class="field">
            <%= f.label :profit_margin, "Markup (%)" %>
            <%= f.number_field :profit_margin,
                              step: 0.01,
                              class: "form-control",
                              data: {
                                "service-form-target": "profit",
                                action: "input->service-form#computeBasePrice"
                              } %>
          </div>

          <div class="field"> <%= f.label :service_price, "Preço total do serviço (R$)" %>
            <%= f.number_field :service_price,
                              readonly: true,
                              class: "form-control",
                              data: { "service-form-target": "basePrice" } %>
          </div>
        </div>

          <%= f.hidden_field :service_items_cost,
                data: { "service-form-target": "itemsCost" } %>
      </div>

        <hr>

        <h2 class="title">Itens Utilizados</h2>

        <h3 class="subtitle">Insumos Utilizados</h3>

    <div data-controller="service-nested-form"
        data-service-nested-form-association-value="clients/inputs">

          <!-- Container onde os blocos existentes e novos serão inseridos -->
          <div data-service-nested-form-target="items">
            <%= f.fields_for :service_inputs do |input_form| %>
              <%= render "services/services/service_input_fields", f: input_form %>
            <% end %>
          </div>

          <template data-service-nested-form-target="template">
            <%= f.fields_for :service_inputs,
                            Services::ServiceInput.new,
                            child_index: "NEW_SERVICE_INPUT" do |ff| %>
              <%= render "services/services/service_input_fields", f: ff %>
            <% end %>
          </template>

          <%= link_to "Adicionar Item", "#",
                class: "action-button",
                data: { action: "service-nested-form#add" } %>
        </div>

        <hr>
        <h3 class="subtitle">Subprodutos Utilizados</h3>

    <div data-controller="service-nested-form"
        data-service-nested-form-association-value="clients/subproducts">

          <div data-service-nested-form-target="items">
            <%= f.fields_for :service_subproducts do |ff| %>
              <%= render "services/services/service_subproduct_fields", f: ff %>
            <% end %>
          </div>
          <template data-service-nested-form-target="template">
            <%= f.fields_for :service_subproducts, Services::ServiceSubproduct.new, child_index: "NEW_SERVICE_SUBPRODUCT" do |ff| %>
              <%= render "services/services/service_subproduct_fields", f: ff %>
            <% end %>
          </template>
          <%= link_to "Adicionar Subproduto", "#", class: "action-button",
                      data: { action: "service-nested-form#add" } %>
        </div>

        <hr>

        <h3 class="subtitle">Produtos Utilizados</h3>

      <div data-controller="service-nested-form"
          data-service-nested-form-association-value="clients/products">

          <div data-service-nested-form-target="items">
            <%= f.fields_for :service_products do |ff| %>
              <%= render "services/services/service_product_fields", f: ff %>
            <% end %>
          </div>

          <template data-service-nested-form-target="template">
            <%= f.fields_for :service_products,
                            Services::ServiceProduct.new,
                            child_index: "NEW_SERVICE_PRODUCT" do |ff| %>
              <%= render "services/services/service_product_fields", f: ff %>
            <% end %>
          </template>

          <%= link_to "Adicionar Produto", "#",
                class: "action-button",
                data: { action: "service-nested-form#add" } %>
        </div>

        <hr>
        <h3 class="subtitle">Energias Utilizadas</h3>

      <div data-controller="service-nested-form"
          data-service-nested-form-association-value="clients/services/energies">

          <div data-service-nested-form-target="items">
            <%= f.fields_for :service_energies do |ff| %>
              <%= render "services/services/service_energy_fields", f: ff %>
            <% end %>
          </div>

          <template data-service-nested-form-target="template">
            <%= f.fields_for :service_energies,
                            Services::ServiceEnergy.new,
                            child_index: "NEW_SERVICE_ENERGY" do |ff| %>
              <%= render "services/services/service_energy_fields", f: ff %>
            <% end %>
          </template>

          <%= link_to "Adicionar Energia", "#",
                class: "action-button",
                data: { action: "service-nested-form#add" } %>
        </div>

        <hr>
        <h3 class="subtitle">Equipamentos Utilizados</h3>

      <div data-controller="service-nested-form"
          data-service-nested-form-association-value="clients/services/equipments">
          
          <div data-service-nested-form-target="items">
            <%= f.fields_for :service_equipments do |ff| %>
              <%= render "services/services/service_equipment_fields", f: ff %>
            <% end %>
          </div>

          <template data-service-nested-form-target="template">
            <%= f.fields_for :service_equipments,
                            Services::ServiceEquipment.new,
                            child_index: "NEW_SERVICE_EQUIPMENT" do |ff| %>
              <%= render "services/services/service_equipment_fields", f: ff %>
            <% end %>
          </template>

          <%= link_to "Adicionar Equipamento", "#",
                class: "action-button",
                data: { action: "service-nested-form#add" } %>
        </div>

        <hr>
        
        <div class="form-row">
          <div class="field">
            <%= f.label :service_items_cost, "Custo total dos itens (R$)" %>
            <%= f.number_field :service_items_cost,
                  id: nil,
                  readonly: true,
                  step: 0.01,
                  class: "form-control",
                  data: { "service-form-target": "itemsCostDisplay" } %>
            <%= f.hidden_field :service_items_cost,
                  id: "services_service_service_items_cost",
                  data: { "service-form-target": "itemsCost" } %>
          </div>

          <div class="field">
            <%= f.label :final_service_price, "Preço final do serviço (R$)" %>
            <%= f.number_field :final_service_price,
                  readonly: true,
                  step: 0.01,
                  class: "form-control",
                  data: { "service-form-target": "finalPrice" } %>
            <%= f.hidden_field :final_service_price,
                  data: { "service-form-target": "finalPriceHidden" } %>
          </div>
        </div>

        <div class="form-actions">
          <%= f.submit "Salvar Serviço", class: "standart-button" %>
        </div>
    <% end %>
</main>