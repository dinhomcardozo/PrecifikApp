<%= form_with model: @service, local: true do |f| %>

  <% if @service.errors.any? %>
    <div class="error_explanation">
      <h2>
        <%= pluralize(@service.errors.count, "erro") %> proibiu este serviço de ser salvo:
      </h2>
      <ul>
        <% @service.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-inputs">

    <!-- Descrição -->
    <div class="field">
      <%= f.label :description, "Descrição" %>
      <%= f.text_field :description, class: "form-control" %>
    </div>

    <!-- Professional -->
    <div class="field" data-controller="service-form">
  <div class="field">
    <%= f.label :professional_id, "Profissional" %>
    <%= f.select :professional_id,
                 @professionals.map { |p| [p.full_name, p.id] },
                 { prompt: "Selecione Profissional" },
                 class: "form-control",
                 data: {
                   action:                "change->service-form#loadHourlyRate",
                   "service-form-target":  "professionalSelect"
                 } %>
  </div>

    <!-- Hourly rate (readonly) -->
    <div class="field">
      <%= f.label :hourly_rate, "Hourly Rate (R$)" %>
      <%= f.number_field :hourly_rate,
                        readonly: true,
                        class: "form-control",
                        data: { "service-form-target": "hourlyRate" } %>
    </div>

    <!-- Total Hours bruto (DD:HH:MM:SS) -->
    <div class="field">
      <%= f.label :total_hours_raw, "Total Hours (DD:HH:MM:SS)" %>
      <%= f.text_field :total_hours_raw,
                      placeholder: "00:DD:HH:MM:SS",
                      class: "form-control",
                      data: {
                        "service-form-target": "totalRaw",
                        action:                 "blur->service-form#parseTotalHours"
                      } %>
    </div>

    <!-- Total Hours decimal (hidden) -->
    <%= f.hidden_field :total_hours,
                      data: { "service-form-target": "totalDecimal" } %>

    <!-- Tax (%) -->
    <div class="field">
      <%= f.label :tax, "Tax (%)" %>
      <%= f.number_field :profit_margin,
                        step: 0.01,
                        class: "form-control",
                        data: {
                          "service-form-target": "profit",
                          action:                 "input->service-form#computeBasePrice"
                        } %>
    </div>

    <!-- Profit Margin (%) -->
    <div class="field">
      <%= f.label :profit_margin, "Profit Margin (%)" %>
      <%= f.number_field :profit_margin,
                         step: 0.01,
                         class: "form-control",
                         data: {
                           target: "service-form.profit",
                           action: "input->service-form#computeBasePrice"
                         } %>
    </div>

    <!-- Service Price (readonly) -->
    <div class="field">
      <%= f.label :service_price, "Service Price (R$)" %>
      <%= f.number_field :service_price,
                        readonly: true,
                        class: "form-control",
                        data: { "service-form-target": "basePrice" } %>
    </div>
  </div>

  <hr>

  <h3>Itens Utilizados</h3>

  <div
    data-controller="service-nested-form"
    data-service-nested-form-association-value="service_inputs"
  >
    <!-- Container onde os blocos existentes e novos serão inseridos -->
    <div data-service-nested-form-target="items">
      <%= f.fields_for :service_inputs do |input_form| %>
        <%= render "services/services/service_input_fields", f: input_form %>
      <% end %>
    </div>

    <template data-service-nested-form-target="template">
      <%= f.fields_for :service_inputs,
                      Services::ServiceInput.new,
                      child_index: "NEW_SERVICE_INPUT" do |ff| %>
        <%= render "services/services/service_input_fields", f: ff %>
      <% end %>
    </template>

    <%= link_to "Adicionar Item", "#",
          class: "action-button",
          data: { action: "service-nested-form#add" } %>
  </div>

  <div class="form-actions" style="margin-top: 1rem;">
    <%= f.submit "Salvar Service", class: "standart-button" %>
  </div>
<% end %>