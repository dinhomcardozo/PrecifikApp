<!-- app/views/sales_targets/index.html.erb -->

<main class="index-container">
  <h1>Metas de Vendas</h1>
  <%= link_to "[+] Criar Meta de Venda",
              new_sales_target_path,
              class: "standart-button" %>

  <table class="index-table index-table--bordered" >
    <thead>
      <tr>
        <th>Produto</th>
        <th>Meta Mensal</th>
        <th>Data Inicial</th>
        <th>Data Final</th>
        <th colspan="2">A√ß√µes</th>
        <th>Status</th>
      </tr>
    </thead>

    <tbody>
      <% @sales_targets.each do |sales_target| %>
        <tr id="<%= dom_id sales_target %>">
          <td>
            <% if sales_target.product_portion.present? %>
              <%= sales_target.product_portion.product.description %>
              (<%= number_with_precision(sales_target.product_portion.portioned_quantity, precision: 0) %> g)
            <% else %>
              -
            <% end %>
          </td>
          <td><%= sales_target.monthly_target %></td>
          <td><%= l(sales_target.start_date, format: "%d/%m/%Y") %></td>
          <td><%= l(sales_target.end_date, format: "%d/%m/%Y") %></td>
          <td class="cell-actions">
            <%= link_to "Editar", edit_sales_target_path(sales_target), class: "action-button" %>
          </td>
          <td class="cell-actions">
            <%= link_to "Excluir",
                        sales_target_path(sales_target),
                        method: :delete,
                        data: { confirm: "Tem certeza que deseja excluir esta meta?" },
                        class: "action-button" %>
          </td>
          <td>
            <% today  = Date.current
              start  = sales_target.start_date
              ending = sales_target.end_date %>
            <% if today < start %>
              ‚ö™Ô∏è
            <% elsif today > ending %>
              üî¥
            <% elsif today == ending %>
              üü†
            <% else %>
              üü¢
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="totals-box mt-3">
    <p class="custom-label"><strong>Total de Metas (unidades):</strong>
      <%= @sales_target_sum %>
    </p>
    <p class="custom-label"><strong>Custo Fixo Distribu√≠do Global (R$):</strong>
      <%= number_to_currency(SalesTarget.global_distributed_fixed_cost_live, unit: "R$ ") %>
    </p>
  </div>


  <hr>

  <div class="accordion" id="salesTargetsAccordion">

    <!-- Expected Revenue -->
    <div class="accordion-item expected-revenue">
      <h2 class="accordion-header" id="headingExpectedRevenue">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapseExpectedRevenue"
                aria-expanded="false" aria-controls="collapseExpectedRevenue">
          Previs√£o de Faturamento
        </button>
      </h2>
      <div id="collapseExpectedRevenue" class="accordion-collapse collapse"
          aria-labelledby="headingExpectedRevenue" data-bs-parent="#salesTargetsAccordion">
        <div class="accordion-body">
          <div class="totals-box">
            <p><strong>Faturamento previsto Varejo (ativos):</strong>
              <%= number_to_currency(@expected_retail_revenue, unit: "R$ ") %>
            </p>
            <p><strong>Faturamento previsto Atacado (ativos):</strong>
              <%= number_to_currency(@expected_wholesale_revenue, unit: "R$ ") %>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Without Sales Targets -->
    <div class="accordion-item products-without-sales-targets">
      <h2 class="accordion-header" id="headingProductsWithout">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapseProductsWithout"
                aria-expanded="false" aria-controls="collapseProductsWithout">
          Produtos sem Meta de Venda
        </button>
      </h2>
      <div id="collapseProductsWithout" class="accordion-collapse collapse"
          aria-labelledby="headingProductsWithout" data-bs-parent="#salesTargetsAccordion">
        <div class="accordion-body">
          <table class="index-table index-table--bordered">
            <thead>
              <tr>
                <th>Produto</th>
                <th>Categoria</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              <% @product_portions_without_sales_target.each do |portion| %>
                <tr>
                  <td><%= portion.product.description %> (<%= portion.portioned_quantity %> g)</td>
                  <td><%= portion.product.category&.name || "-" %></td>
                  <td>
                    <%= link_to "Criar",
                                new_sales_target_path(product_portion_id: portion.id),
                                class: "action-button" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>