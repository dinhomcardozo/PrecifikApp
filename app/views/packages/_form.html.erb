<!-- app/views/packages/_form.html.erb -->

<%= form_with model: @package, local: true do |f| %>

  <div class="field">
    <%= f.label :description, "Nome do Pacote" %>
    <%= f.text_field :description,
          class: "form-control",
          placeholder: "Digite o nome do pacote" %>
  </div>

  <div class="field">
    <%= f.label :brand_id, "Marca" %>
    <%= f.collection_select :brand_id,
          Brand.all,
          :id,
          :name,
          { prompt: "Selecione marca" },
          { class: "form-control" } %>
  </div>

  <div class="field">
    <%= f.label :channel_id, "Canal de Venda" %>
    <%= f.collection_select :channel_id,
          Channel.all,
          :id,
          :description,
          { prompt: "Selecione canal" },
          { class: "form-control" } %>
  </div>

  <div class="field">
    <%= f.label :general_discount, "Desconto Geral (%)" %>
    <%= f.number_field :general_discount,
          class: "form-control",
          step: :any,
          min: 0 %>
  </div>

  <h4>Composição do Pacote</h4>

  <div
    data-controller="package-nested-form"
    data-package-nested-form-target="container"
    data-package-nested-form-template-id-value="composition-fields-template"
  >
    <table class="table">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Peso (g)</th>
          <th>Desconto (%)</th>
          <th>Preço</th>
          <th>Subprice</th>
          <th>Ações</th>
        </tr>
      </thead>

      <tbody>
        <% f.fields_for :package_compositions do |pc| %>
          <%= render "packages/package_composition_fields", f: pc %>
        <% end %>
      </tbody>
    </table>

    <!-- botão agora DENTRO do mesmo controller -->
    <button
      type="button"
      class="btn btn-secondary mb-2"
      data-action="package-nested-form#addField"
    >
      Adicionar Product
    </button>

    <!-- template precisa ter o mesmo id declarado no data-attribute acima -->
    <template id="composition-fields-template">
      <%= f.fields_for :package_compositions,
            PackageComposition.new,
            child_index: "NEW_RECORD" do |pc| %>
        <%= render "packages/package_composition_fields", f: pc %>
      <% end %>
    </template>
  </div>

  <div class="actions mt-3">
    <%= f.submit "Salvar Pacote", class: "btn btn-primary" %>
  </div>
<% end %>