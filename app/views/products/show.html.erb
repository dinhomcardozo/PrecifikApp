<!-- app/views/products/show.html.erb -->
<main class="index-container">
  <div class="detailed-box">
    <div>
      <p class="detailed-text">
        <strong>ATENÇÃO!</strong> Edite isso com cuidado. Outros itens podem depender deste Produto.
      </p>                 
      <p class="dependent-item-count">
        <%= "Você tem " + "#{pluralize(@services_count, 'Serviço')}" + " utilizando este item" %>.
        <a href="#" data-bs-toggle="modal" data-bs-target="#assocModal">
          Clique aqui e veja a lista.
        </a>
      </p>
      <div>
        <%= render "product_dependent_items_modal",
                  services: @services %>
      </div>
    </div>
  </div>


  <%= turbo_frame_tag "product_steps" do %>
    <h1 class="title">Detalhes do Produto</h1>

    <div>
      <div class="custom-label">
        <%= link_to "<- Voltar",
                    products_path,
                    data: { turbo_frame: "product_steps", turbo_action: "advance" },
                    class: "standart-button" %>
        <%= link_to "Editar",
                    edit_product_path(@product, step: 1),
                    data: { turbo_frame: "_top" },
                    class: "action-button",
                    title: "Editar" %>
      </div>
    </div>

    <hr>

    <table class="vertical-table--bordered">
      <tr>
        <th>Descrição:</th>
        <td><%= @product.description %></td>
      </tr>
      <tr>
        <th>Marca:</th>
        <td><%= @product.brand&.name %></td>
      </tr>
      <tr>
        <th>Imagem:</th>
        <td>
          <% if @product.image.attached? %>
            <%= image_tag url_for(@product.image), alt: @product.description, class: "index_image", width: 300, height: 300 %>
          <% else %>
            Nenhuma
          <% end %>
        </td>
      </tr>
      <tr>
        <th>Total Custo (R$):</th>
        <td><%= number_to_currency(@product.total_cost, unit: "R$ ") %></td>
      </tr>
      <tr>
        <th>Total c/ Tributos (R$):</th>
        <td><%= number_to_currency(@product.total_cost_with_taxes, unit: "R$ ") %></td>
      </tr>
      <tr>
        <th>Preço Sugerido Varejo (R$):</th>
        <td><%= number_to_currency(@product.suggested_price_retail, unit: "R$ ") %></td>
      </tr>
      <tr>
        <th>Preço Sugerido Atacado (R$):</th>
        <td><%= number_to_currency(@product.suggested_price_wholesale, unit: "R$ ") %></td>
      </tr>
      <tr>
        <th>Lucro Líquido Varejo (R$):</th>
        <td><%= number_to_currency(@product.net_profit_retail, unit: "R$ ") %></td>
      </tr>
      <tr>
        <th>Lucro Líquido Atacado (R$):</th>
        <td><%= number_to_currency(@product.net_profit_wholesale, unit: "R$ ") %></td>
      </tr>
      <tr>
        <th>Margem Real Varejo (%) (R$):</th>
        <td><%= number_to_percentage(@product.real_profit_retail_margin, precision: 2) %></td>      </tr>
      <tr>
        <th>Margem Real Atacado (%):</th>
        <td><%= number_to_percentage(@product.real_profit_wholesale_margin, precision: 2) %></td>
      </tr>
    </table>

    <hr>

    <section class="show-composition mb-4">
      <h2 class="subtitle">Composição</h2>
      <table class="index-table index-table--bordered">
        <thead>
          <tr>
            <th>Insumo</th>
            <th>Quantidade (g)</th>
            <th>Quantidade c/ Perda (g)</th>
            <th>Custo Unitário (R$)</th>
          </tr>
        </thead>
        <tbody>
          <% @product.product_subproducts.each do |ps| %>
            <tr>
              <td><%= ps.subproduct.name %></td>
              <td><%= ps.quantity %></td>
              <td><%= ps.quantity_with_loss %></td>
              <td><%= number_to_currency(ps.cost, unit: "R$ ") %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </section>
    <section>
      <table class="vertical-table--bordered" >
          <tr>
            <th>Peso total (g)</th>
            <td><%= number_with_precision(@product.final_weight, precision: 2) %></td>
          </tr>
      </table>
    </section>
    <hr>
  <% end %>

  <div class="accordion" id="productAccordion">

    <!-- Nutritional Summary -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingNutritional">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapseNutritional"
                aria-expanded="false" aria-controls="collapseNutritional">
          Informações Nutricionais
        </button>
      </h2>
      <div id="collapseNutritional" class="accordion-collapse collapse"
          aria-labelledby="headingNutritional" data-bs-parent="#productAccordion">
        <div class="accordion-body">
          <%= render 'nutritional_summary' %>
        </div>
      </div>
    </div>

    <!-- Outras Porções -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingPortions">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapsePortions"
                aria-expanded="false" aria-controls="collapsePortions">
          Outras Porções do Produto
        </button>
      </h2>
      <div id="collapsePortions" class="accordion-collapse collapse"
          aria-labelledby="headingPortions" data-bs-parent="#productAccordion">
        <div class="accordion-body">
          <table class="index-table index-table--bordered">
            <thead>
              <tr>
                <th>Quantidade (g)</th>
                <th>Custo Produto</th>
                <th>Custo Embalado (sem margem)</th>
                <th>Preço Varejo</th>
                <th>Preço Atacado</th>
              </tr>
            </thead>
            <tbody>
              <% @product.product_portions.each do |portion| %>
                <tr>
                  <td><%= portion.portioned_quantity %></td>
                  <td><%= number_to_currency(portion.portion_cost, unit: "R$ ") %></td>
                  <td><%= number_to_currency(portion.packaged_cost, unit: "R$ ") %></td>
                  <td><%= number_to_currency(portion.packaged_price_retail, unit: "R$ ") %></td>
                  <td><%= number_to_currency(portion.packaged_price_wholesale, unit: "R$ ") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Preço Final por Canal -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingChannels">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#collapseChannels"
                aria-expanded="false" aria-controls="collapseChannels">
          Preço Final por Canal
        </button>
      </h2>
      <div id="collapseChannels" class="accordion-collapse collapse"
          aria-labelledby="headingChannels" data-bs-parent="#productAccordion">
        <div class="accordion-body">
          <table class="index-table index-table--bordered">
            <thead>
              <tr>
                <th>Canal</th>
                <th>Percentagem do Canal (%)</th>
                <th>Preço Final com Comissão (R$)</th>
              </tr>
            </thead>
            <tbody>
              <% Channel.all.each do |channel| %>
                <% base_price = @product.suggested_price_retail.to_f %>
                <% final_price = base_price * (1 + channel.channel_cost.to_f / 100) %>
                <tr>
                  <td><%= channel.description %></td>
                  <td><%= number_to_percentage(channel.channel_cost, precision: 2) %></td>
                  <td><%= number_to_currency(final_price, unit: "R$ ") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>