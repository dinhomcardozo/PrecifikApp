<!-- app/views/products/_product_composition.html.erb -->
<h5 class="subtitle">2) Composição do Produto</h5>

<div data-controller="product-composition">
  <div class="mb-3">
    <%= render "products/add_subproduct_button" %>
    <%= render "products/add_input_button" %>
  </div>

<!-- Template inicial para INPUT -->
  <template id="template-input">
    <%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %>
      <!-- Corrigido: apenas <tr>, sem <tbody>, e sem data-unit fixo -->
      <tr data-controller="composition-row" data-type="input" data-new-record="true">
        <td colspan="4">
          <%= ps.collection_select :input_id,
                Input.order(:name),
                :id,
                :name,
                { prompt: "Selecione Input" },
                { class: "form-select",
                  data: { action: "change->product-composition#renderInputFields" } } do |i| %>
            <option value="<%= i.id %>"
                    data-unit="<%= i.unit_of_measurement %>"
                    data-cost="<%= i.cost %>"
                    data-weight="<%= i.weight %>">
              <%= i.name %>
            </option>
          <% end %>
        </td>
        <td>
          <%= ps.hidden_field :_destroy, class: "destroy-flag" %>
          <button type="button" class="mini-button btn btn-danger"
                  data-action="composition-row#removeRow">Remover</button>
        </td>
      </tr>
    <% end %>
  </template>

  <!-- Template inicial para SUBPRODUCT -->
  <template id="template-subproduct">
    <%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %>
      <!-- Corrigido: apenas <tr>, sem <tbody>, e sem data-unit fixo -->
      <tr data-controller="composition-row" data-type="subproduct" data-new-record="true">
        <td colspan="4">
          <%= ps.collection_select :subproduct_id,
                Subproduct.order(:name),
                :id,
                :name,
                { prompt: "Selecione Subproduto" },
                { class: "form-select",
                  data: { action: "change->product-composition#renderSubproductFields" } } do |s| %>
            <option value="<%= s.id %>"
                    data-unit="<%= s.unit_of_measurement %>"
                    data-cost-per-gram="<%= s.cost_per_gram %>"
                    data-cost-per-unit="<%= s.cost_per_unit %>"
                    data-cost-per-m2="<%= s.cost_per_m2 %>">
              <%= s.name %>
            </option>
          <% end %>
        </td>
        <td>
          <%= ps.hidden_field :_destroy, class: "destroy-flag" %>
          <button type="button" class="mini-button btn btn-danger"
                  data-action="composition-row#removeRow">Remover</button>
        </td>
      </tr>
    <% end %>
  </template>

  <table class="table">

    <thead>
      <tr></tr>
    </thead>

    <tbody data-product-composition-target="list">
      <%= f.fields_for :product_subproducts do |ps| %>
        <% if ps.object.subproduct.present? %>
          <% unit = ps.object.subproduct.unit_of_measurement %>
          <% if unit.in?(%w[g ml]) %>
            <%= render "products/product_composition_weight", f: ps %>
          <% elsif unit == "un" %>
            <%= render "products/product_composition_unit", f: ps %>
          <% elsif unit == "m2" %>
            <%= render "products/product_composition_m2", f: ps %>
          <% end %>
        <% elsif ps.object.input.present? %>
          <% unit = ps.object.input.unit_of_measurement %>
          <% if unit.in?(%w[g ml]) %>
            <%= render "products/product_input_composition_weight", f: ps %>
          <% elsif unit == "un" %>
            <%= render "products/product_input_composition_unit", f: ps %>
          <% elsif unit == "m2" %>
            <%= render "products/product_input_composition_m2", f: ps %>
          <% end %>
        <% end %>
      <% end %>
    </tbody>
  </table>

  <!-- Templates finais para substituição -->
  <template id="template-subproduct-weight"><%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %><%= render "products/product_composition_weight", f: ps %><% end %></template>
  <template id="template-subproduct-unit"><%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %><%= render "products/product_composition_unit", f: ps %><% end %></template>
  <template id="template-subproduct-m2"><%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %><%= render "products/product_composition_m2", f: ps %><% end %></template>

  <template id="template-input-weight"><%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %><%= render "products/product_input_composition_weight", f: ps %><% end %></template>
  <template id="template-input-unit"><%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %><%= render "products/product_input_composition_unit", f: ps %><% end %></template>
  <template id="template-input-m2"><%= f.fields_for :product_subproducts, ProductSubproduct.new, child_index: "NEW_RECORD" do |ps| %><%= render "products/product_input_composition_m2", f: ps %><% end %></template>

  <div class="row mt-3">
    <div class="col-md-3 mb-3">
      <%= f.label :weight_loss, "Perda de Peso (%)", class: "custom-label" %>
      <%= f.number_field :weight_loss,
            step: 0.01,
            class: "form-control",
            data: {
              action: "input->product-composition#recalcWeights",
              product_composition_target: "weightLoss"
            } %>
    </div>

    <div class="col-md-3 mb-3">
      <%= f.label :total_weight, "Peso Bruto (g)", class: "custom-label" %>
      <%= f.number_field :total_weight,
            readonly: true,
            class: "form-control",
            data: { product_composition_target: "grossWeight" } %>
    </div>

    <div class="col-md-3 mb-3">
      <%= f.label :final_weight, "Peso Final (g)", class: "custom-label" %>
      <%= f.number_field :final_weight,
            readonly: true,
            class: "form-control",
            data: { product_composition_target: "finalWeight" } %>
    </div>

    <div class="col-md-3 mb-3">
      <%= f.label :total_cost, "Custo Total (R$)", class: "custom-label" %>
      <%= f.number_field :total_cost,
            readonly: true,
            class: "form-control",
            value: @product.total_cost.to_f.round(2) %>
    </div>

    <div class="mt-3 text-end d-none" data-product-composition-target="finalizeButton">
      <%= f.submit "Finalizar", class: "action-button" %>
    </div>
  </div>
</div>