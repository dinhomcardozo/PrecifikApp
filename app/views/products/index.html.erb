<!-- app/views/products/index.html.erb -->
<main class="index-container">
  <%= turbo_frame_tag "product_steps" do %>
    <h1 class="title">Produtos</h1>
    <div class="index-actions">
      <%= link_to "[+] Novo Produto",
                  new_product_path,
                  data: { turbo_frame: "product_steps" },
                  class: "standart-button" %>
    </div>
    <hr>

    <%= form_with url: products_path, method: :get,
                  data: { controller: "autosubmit", turbo_frame: "products_table" } do %>
      <%= text_field_tag :q, params[:q],
            class: "form-control",
            placeholder: "Digite o nome de algum produto...",
            data: { action: "input->autosubmit#submit" } %>
      <button type="submit" hidden></button>
    <% end %>

    <%= turbo_frame_tag "products_table" do %>
      <table id="products-table" class="index-table index-table--bordered">
        <thead>
          <tr>
            <% headers = [
                ["products.description",            "Descrição"],
                ["products.image",            "Imagem"],
                ["products.total_cost",             "Custo Total (R$)"]
              ] %>

            <% headers.each do |column, title| %>
              <% current = params[:sort] == column %>
              <% dir     = current && params[:direction] == "asc" ? "asc" : "desc" %>
              <% th_css  = current ? "sorted #{dir}" : nil %>

              <th class="<%= th_css %>">
                <%= link_to title,
                      url_for(
                        request.query_parameters
                              .merge(sort: column,
                                      direction: (current && dir == "asc" ? "desc" : "asc"),
                                      page: nil)
                      ) %>
              </th>
            <% end %>

            <th> </th>
            <th> </th>
          </tr>
        </thead>

        <tbody>
          <% @products.each do |p| %>
            <tr data-table-filter-target="row" id="<%= dom_id(p) %>">
              <td><%= p.description %></td>
              <td>
                <% if p.image.attached? %>
                  <%= image_tag url_for(p.image),
                                alt: p.description,
                                class: "index_image",
                                width: 100,
                                height: 100 %>
                <% else %>
                  Nenhuma
                <% end %>
              </td>
              <td><%= number_to_currency(p.total_cost,               unit: "R$ ") %></td>
              <td class="cell-actions">
                <%= link_to product_path(p),
                            data: { turbo_frame: "_top" },
                            class: "link-icon-actions",
                            title: "Ver" do %>
                  <%= image_tag "icons/ver.png",
                                alt: "Ver",
                                class: "action-icon" %>
                <% end %>
              </td>
              <td class="cell-actions">
                <%= link_to edit_product_path(p, step: 1),
                            data: { turbo_frame: "product_steps" },
                            class: "link-icon-actions",
                            title: "Editar" do %>
                  <%= image_tag "icons/editar.png",
                                alt: "Editar",
                                class: "action-icon" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>

    <% if action_name == "index" %>
      <%= will_paginate @products,
            previous_label: '<i class="bi bi-arrow-left"></i> Anterior'.html_safe,
            next_label: 'Próximo <i class="bi bi-arrow-right"></i>'.html_safe %>
    <% end %>
  <% end %>
</main>